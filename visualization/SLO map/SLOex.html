
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>SLO Temperatures</title>

    <style>
      html, body, #map-div {
        margin: 0;
        padding: 0;
        height: 100%;
      }
    </style>

    <script>
        ///////////////////
        // Configuration //
        ///////////////////

        var pointFileURL = 'http://equinox.iondune.com/pipelines/js/SLOPoints.js';


        /////////////
        // Globals //
        /////////////

        // Google Maps API handle
        var map;

        // WebGL canvas
        var canvasLayer;

        // WebGL context
        var gl;

        // WebGL program
        var pointProgram;

        // WebGL array
        var pointArrayBuffer;

        // Maps pixel coordinates to WebGL coordinates
        var pixelsToWebGLMatrix = new Float32Array(16);

        // Data range
        var dataMax;
        var dataMin;

        function init() {

            // Initialize Map
            var mapOptions = {
              zoom: 12,
              //39.3, -8.8
              center: new google.maps.LatLng(35.29, -120.67),
              mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            var mapDiv = document.getElementById('map-div');
            map = new google.maps.Map(mapDiv, mapOptions);

            noty({id: 'loading', text: "Loading Points... Please wait...", layout: 'topCenter'});
            $.getScript(pointFileURL, function() {

                // Initialize canvas
                var canvasLayerOptions = {
                  map: map,
                  resizeHandler: resize,
                  animate: false,
                  updateHandler: update
                };
                canvasLayer = new CanvasLayer(canvasLayerOptions);

                // Initialize WebGL
                gl = canvasLayer.canvas.getContext('experimental-webgl');

                createShaderProgram();
                loadData();

                $.noty.close('loading');
                update();
            });
        }

        function createShaderProgram() {

            // Vertex shader
            var vertexSrc = document.getElementById('pointVertexShader').text;
            var vertexShader = gl.createShader(gl.VERTEX_SHADER);
            gl.shaderSource(vertexShader, vertexSrc);
            gl.compileShader(vertexShader);

            // Fragment shader
            var fragmentSrc = document.getElementById('pointFragmentShader').text;
            var fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
            gl.shaderSource(fragmentShader, fragmentSrc);
            gl.compileShader(fragmentShader);

            // Link program
            pointProgram = gl.createProgram();
            gl.attachShader(pointProgram, vertexShader);
            gl.attachShader(pointProgram, fragmentShader);
            gl.linkProgram(pointProgram);

            gl.useProgram(pointProgram);
            gl.aPointSize = gl.getAttribLocation(pointProgram, "aPointSize");
        }

        function loadData() {

            dataMax = -Infinity;
            dataMin = Infinity;

            var rawData = new Float32Array(3 * points.length);
            for (var i = 0; i < points.length; i++) {
                var pixel = LatLongToPixelXY(points[i].lat, points[i].lon);
                rawData[i * 3] = pixel.x ;
                rawData[i * 3 + 1] = pixel.y;
                rawData[i * 3 + 2] = points[i].temp;

                if (points[i].temp > dataMax)
                    dataMax = points[i].temp;
                if (points[i].temp < dataMin)
                    dataMin = points[i].temp;
            }

            pointArrayBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, pointArrayBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, rawData, gl.STATIC_DRAW);

            var attributeLoc = gl.getAttribLocation(pointProgram, 'worldCoord');
            gl.enableVertexAttribArray(attributeLoc);
            gl.vertexAttribPointer(attributeLoc, 3, gl.FLOAT, false, 0, 0);

        }

        function resize() {

            var width = canvasLayer.canvas.width;
            var height = canvasLayer.canvas.height;

            gl.viewport(0, 0, width, height);
            pixelsToWebGLMatrix.set([2/width, 0, 0, 0, 0, -2/height, 0, 0, 0, 0, 0, 0, -1, 1, 0, 1]);
        }

        function scaleMatrix(matrix, scaleX, scaleY) {

            matrix[0] *= scaleX;
            matrix[1] *= scaleX;
            matrix[2] *= scaleX;
            matrix[3] *= scaleX;

            matrix[4] *= scaleY;
            matrix[5] *= scaleY;
            matrix[6] *= scaleY;
            matrix[7] *= scaleY;
        }

        function translateMatrix(matrix, tx, ty) {

            matrix[12] += matrix[0]*tx + matrix[4]*ty;
            matrix[13] += matrix[1]*tx + matrix[5]*ty;
            matrix[14] += matrix[2]*tx + matrix[6]*ty;
            matrix[15] += matrix[3]*tx + matrix[7]*ty;
        }

        function update() {

            if (points == undefined)
                return;

            gl.clear(gl.COLOR_BUFFER_BIT);

            gl.vertexAttrib1f(gl.aPointSize, Math.max(map.zoom - 6.0, 1.0));

            var mapMatrix = new Float32Array(16);
            mapMatrix.set(pixelsToWebGLMatrix);

            var scale = Math.pow(2, map.zoom);
            scaleMatrix(mapMatrix, scale, scale);

            var offset = map.getProjection().fromLatLngToPoint(canvasLayer.getTopLeft());
            translateMatrix(mapMatrix, -offset.x, -offset.y);

            var matrixLoc = gl.getUniformLocation(pointProgram, 'mapMatrix');
            gl.uniformMatrix4fv(matrixLoc, false, mapMatrix);

            gl.uniform1f(gl.getUniformLocation(pointProgram, 'dataMax'), dataMax);
            gl.uniform1f(gl.getUniformLocation(pointProgram, 'dataMin'), dataMin);

            gl.drawArrays(gl.POINTS, 0, points.length);
        }

    </script>

    <script id="pointVertexShader" type="x-shader/x-vertex">
        attribute vec4 worldCoord;
        attribute float aPointSize;
        uniform mat4 mapMatrix;

        varying float temperature;

        void main() {
            temperature = worldCoord.z;

            gl_Position = mapMatrix * worldCoord;
            gl_PointSize = aPointSize;
        }
    </script>

    <script id="pointFragmentShader" type="x-shader/x-fragment">
        precision mediump float;
        varying float temperature;

        uniform float dataMin;
        uniform float dataMax;

        void main() {
            float value = (temperature - dataMin) / (dataMax - dataMin);
            gl_FragColor = vec4(value, 0.0, 1.0 - value, 0.3);
        }
    </script>
  </head>

  <body>

    <div id="map-div"></div>

    <script src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>

    <script src="js/CanvasLayer.js"></script>
    <script src="js/Utils.js"></script>
    <script src="js/noty/jquery.noty.js"></script>
    <script src="js/noty/layouts/topCenter.js"></script>
    <script src="js/noty/themes/default.js"></script>

    <script>
        $(function() {
            init();
        });
    </script>

  </body>
</html>
