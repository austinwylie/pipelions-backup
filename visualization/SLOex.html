
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>SLO Temperatures</title>

    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" />

    <style>
      html, body, #map-div {
        margin: 0;
        padding: 0;
        height: 95%;
      }
    </style>

    <script>
        ///////////////////
        // Configuration //
        ///////////////////

        var pointFileURL = 'http://equinox.iondune.com/pipelines/js/data/';

        /////////////
        // Globals //
        /////////////

        // Google Maps API handle
        var map;

        // WebGL canvas
        var canvasLayer;

        // WebGL context
        var gl;

        // WebGL program
        var pointProgram;

        // Maps pixel coordinates to WebGL coordinates
        var pixelsToWebGLMatrix = new Float32Array(16);

        // WebGL arrays for each data source
        var dataSources = new Array();

        // Data range
        var dataMax;
        var dataMin;

        // Number of data files to load
        var dataFiles = 4;

        function init() {

            var data = $.Deferred();

            // Initialize Map
            var mapOptions = {
              zoom: 16,
              //39.3, -8.8
              center: new google.maps.LatLng(35.295, -120.67),
              mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            var mapDiv = document.getElementById('map-div');
            map = new google.maps.Map(mapDiv, mapOptions);

            // Initialize canvas
            var canvasLayerOptions = {
              map: map,
              resizeHandler: resize,
              animate: false,
              updateHandler: update
            };
            canvasLayer = new CanvasLayer(canvasLayerOptions);

            // Initialize WebGL
            gl = canvasLayer.canvas.getContext('experimental-webgl');
            var shaders = createShaderProgram();

            dataMax = -Infinity;
            dataMin = Infinity;

            shaders.done(function ()
            {
                console.debug("Loading data...");
                var loaded = [];
                for (var i = 0; i < dataFiles; i++)
                    loaded.push(loadData(i));

                $.when.apply($, loaded).done(function ()
                {
                    pickDataSource(0);
                    update();
                    console.debug("Loaded data.");
                    data.resolve();
                });
            });

            return data;
        }

        function createShaderProgram()
        {
            var shaders = $.Deferred();

            console.debug("Loading shaders...");
            ShaderLoader.load(
                function (data)
                {
                    var vertexSource = data.point.vertex;
                    var fragmentSource = data.point.fragment;

                    var vertexShader = gl.createShader(gl.VERTEX_SHADER);
                    gl.shaderSource(vertexShader, vertexSource);
                    gl.compileShader(vertexShader);

                    var fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
                    gl.shaderSource(fragmentShader, fragmentSource);
                    gl.compileShader(fragmentShader);

                    pointProgram = gl.createProgram();
                    gl.attachShader(pointProgram, vertexShader);
                    gl.attachShader(pointProgram, fragmentShader);
                    gl.linkProgram(pointProgram);

                    gl.useProgram(pointProgram);
                    gl.aPointSize = gl.getAttribLocation(pointProgram, "aPointSize");

                    console.debug("Loaded shaders.");
                    shaders.resolve();
                }
            );

            return shaders;
        }

        function loadData(index)
        {
            var data = $.Deferred();
            var url = pointFileURL + "SLOPoints" + index + ".js";

            console.debug("Loading from: " + url);
            $.getScript(url, function()
            {
                var rawData = new Float32Array(3 * points.length);
                for (var i = 0; i < points.length; i++)
                {
                    var pixel = LatLongToPixelXY(points[i].lat, points[i].lon);
                    rawData[i * 3] = pixel.x ;
                    rawData[i * 3 + 1] = pixel.y;
                    rawData[i * 3 + 2] = points[i].temp;

                    if (points[i].temp > dataMax)
                        dataMax = points[i].temp;
                    if (points[i].temp < dataMin)
                        dataMin = points[i].temp;
                }

                dataSources[index] = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, dataSources[index]);
                gl.bufferData(gl.ARRAY_BUFFER, rawData, gl.STATIC_DRAW);

                console.debug("Loading from " + url + " is done.");
                data.resolve();
            });

            return data;
        }

        function pickDataSource(index)
        {
            console.debug("Picking data source " + index);
            gl.bindBuffer(gl.ARRAY_BUFFER, dataSources[index]);
            var attributeLoc = gl.getAttribLocation(pointProgram, 'worldCoord');
            gl.enableVertexAttribArray(attributeLoc);
            gl.vertexAttribPointer(attributeLoc, 3, gl.FLOAT, false, 0, 0);
        }

        function resize() {

            var width = canvasLayer.canvas.width;
            var height = canvasLayer.canvas.height;

            gl.viewport(0, 0, width, height);
            pixelsToWebGLMatrix.set([2/width, 0, 0, 0, 0, -2/height, 0, 0, 0, 0, 0, 0, -1, 1, 0, 1]);
        }

        function scaleMatrix(matrix, scaleX, scaleY) {

            matrix[0] *= scaleX;
            matrix[1] *= scaleX;
            matrix[2] *= scaleX;
            matrix[3] *= scaleX;

            matrix[4] *= scaleY;
            matrix[5] *= scaleY;
            matrix[6] *= scaleY;
            matrix[7] *= scaleY;
        }

        function translateMatrix(matrix, tx, ty) {

            matrix[12] += matrix[0]*tx + matrix[4]*ty;
            matrix[13] += matrix[1]*tx + matrix[5]*ty;
            matrix[14] += matrix[2]*tx + matrix[6]*ty;
            matrix[15] += matrix[3]*tx + matrix[7]*ty;
        }

        function update() {
            if (typeof points === 'undefined')
            {
                console.debug("Aborting draw, data not yet loaded.");
                return;
            }

            gl.clear(gl.COLOR_BUFFER_BIT);

            gl.vertexAttrib1f(gl.aPointSize, Math.max(map.zoom - 6.0, 1.0));

            var mapMatrix = new Float32Array(16);
            mapMatrix.set(pixelsToWebGLMatrix);

            var scale = Math.pow(2, map.zoom);
            scaleMatrix(mapMatrix, scale, scale);

            var mapProjection = map.getProjection();
            var offset = mapProjection.fromLatLngToPoint(canvasLayer.getTopLeft());
            translateMatrix(mapMatrix, -offset.x, -offset.y);

            var matrixLoc = gl.getUniformLocation(pointProgram, 'mapMatrix');
            gl.uniformMatrix4fv(matrixLoc, false, mapMatrix);

            gl.uniform1f(gl.getUniformLocation(pointProgram, 'dataMax'), dataMax);
            gl.uniform1f(gl.getUniformLocation(pointProgram, 'dataMin'), dataMin);

            gl.drawArrays(gl.POINTS, 0, points.length);
        }

    </script>

    <script data-name="point" type="x-shader/x-vertex" data-src="js/shaders/pointVertexShader.js"></script>
    <script data-name="point" type="x-shader/x-fragment" data-src="js/shaders/pointFragmentShader.js"></script>

  </head>

  <body>

    <div id="map-div"></div>
    <div id="other-content" style="padding: 20px;">
        <div style="width: 200px">
            Time frame: <div id="slider"></div>
        </div>
        <p><span id="query">0</span></p>
    </div>

    <!-- Google Maps API -->
    <script src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>

    <!-- jQuery -->
    <script src="http://code.jquery.com/jquery-1.11.0.js"></script>
    <script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>

    <!-- Utilities -->
    <script src="js/CanvasLayer.js"></script>
    <script src="js/Utils.js"></script>
    <script src="js/ShaderLoader.min.js"></script>
    <script src="js/noty/jquery.noty.js"></script>
    <script src="js/noty/layouts/topCenter.js"></script>
    <script src="js/noty/themes/default.js"></script>

    <script>
        $(function() {
            init().done(function ()
            {
                console.debug("Initializing slider...");

                function refresh(event, ui) {
                    time = ui.value;
                    $("#query").text(time);
                    pickDataSource(time);
                    update();
                }

                $("#slider").slider({
                    slide: refresh,
                    min: 0,
                    max: dataFiles - 1,
                    step: 1,
                    value: 0
                });
            });
        });
    </script>

  </body>
</html>
